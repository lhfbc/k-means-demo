# K-means实验

## 一、概述

我们这个实验的目的是使用 K-means 算法来对节点进行归类。对 K-means 算法中节点之间距离的度量要素有：节点之间的网络延迟，节点之间的信用度差距。

设两个节点为 m 和 n，网络延迟的值记为 delay(m, n)，信用度差距的值 是 credit(m, n)，那么 `distence(m, n) = a * delay(m, n) + b * credit(m, n)`。其中 a 和 b 是权重。

下面分布进行 delay、credit、a 和 b 的确认。



## 二、节点间的网络延迟 delay

### 1. 说明

在第一版中我们使用了实际的 20 台机器，并通过脚本来获取节点之间的网络延迟。但是由于实际的机器和网络的问题，实验效果不是我们期望的典型的情况。

这里我们通过模拟，期望构造出最典型的场景：有 3 个中心节点，其他的节点相对均匀的围绕在这 3 个点周围，这里我们使用 5 个卫星点来围绕每个中心点。这也是区块链网络中典型的超级节点和普通节点的场景。



### 2. 实验方法

这里使用的模拟方法如下：

* 确定 3 个中心点，设为 N1、N2、N3。再确定三个点之间的距离。

  三个点确定一个三角形和一个平面。三个中心点之间的距离为随机值。但是需要满足形成三角形的条件：任意两条边之和大于第三条边。另外虽然不需要满足等边三角形，但是也不能三个角相差过大，也就是三条边的长度要接近，大致有个等边的概念，然后在上下浮动一点点。

  

* 每个中心点周围有 5 个卫星点。每个卫星点到自己的中心点的距离也是随机值。这个随机范围在 0 和 中心节点之间距离的一半。这是因为超过一半之后这个卫星点就会被划到另一个中心点的范围内。

  

* 每个中心点的 5 个卫星点，彼此之间的距离。

  举个例子，要求出 N1 的 2 个卫星点 A 和 B 之间的距离。

  在几何空间中想一下，N1 、A 、B 三个点在一条直线上或者构成一个三角形。A 和 B 之间的距离 Lab，满足[La1 - Lb1, La1 + Lb1]， 这里 La1 表示 A 到 N1 的距离，Lb1 也类似，这里假设 La1 > Lb1. 

  我们的取值方法是：在这个范围中取一个随机值。

  

* 确认卫星点到其他中心点的距离。

  举个例子，要求出 N1 的卫星节点 X 到 N2 的距离，记为 Lx2。

  在几何空间中设想一下，X、N1、N2 三个点要么在一条直线上，要么可以构成一个三角形，设 N1 到 N2 的距离是 L12，X 到 N1 的距离是 Lx1 ，那么 L12 - Lx1  <=  Lx2 <= L12 + Lx1 。

  我们的取值方法为：用 L12 加或者减（随机的）上一个 Lx1 乘以系数，这个系数是一个 0到1之间的随机值。

  

* 确认不同中心节点的 2 个卫星节点之间的距离。

  举个例子，要求出 N1 的卫星节点 X 到 N2 的卫星节点 Y 之间的距离。可以在三维空间中设想出来，这个距离的范围是[L12 - Lx1 - Ly2,  L12 + Lx1 + Ly2]。

  我们的取值方法：L12 加或减（随机）一个系数乘以 Lx1 和 Ly2 的和，这个系数是 0 和 1 之间的随机值。



### 3. 实验步骤

#### 3.1 确定中心节点，以及之间的距离

选择三个节点，记为 N1、N2、N3.

根据我们的方法：先确定一个等边的长度，然后根据随机值上下浮动。

对我们上一版的实验结果进行简单的分析，得到下面这个频率表。可以看出 16ms 左右的网络延迟占绝大多数。

| 0.271    | 1    |
| -------- | ---- |
| 16.35745 | 181  |
| 32.4439  | 0    |
| 48.53035 | 80   |
| 64.6168  | 31   |
| 80.70325 | 25   |
| 96.7897  | 10   |
| 112.8762 | 0    |
| 128.9626 | 0    |
| 145.0491 | 0    |
| 161.1355 | 0    |
| 177.222  | 12   |
| 193.3084 | 6    |
| 209.3949 | 3    |
| 225.4813 | 14   |
| 241.5678 | 25   |
| 257.6542 | 6    |
| 273.7407 | 2    |
| 289.8271 | 0    |
| 305.9136 | 0    |

所以我们这里选择 20ms 作为等边的长度。

随机范围在 -5 ~ 5 之间

```python
import random
for i in range(3):
	print("%.2f" % (random.uniform(-5, 5)))
```

保留 2 位小数，得到

``` 
1.62
4.42
-0.69
```

所以 N1~~ N2 是 21.62， N1~~ N3 是 24.42， N2 ~~ N3 是 19.31.



#### 3.2 确定卫星节点到各自中心节点的距离

每个中心节点有 5 个卫星节点。

根据我们的方法：卫星节点到中心节点的距离的取值范围是 0 到 等边距离（20） 的一半，在这个区间取随机值。

```python
import random
for i in range(5):
	print("%.2f" % (random.uniform(0, 10)))
```

运行 3 次，保留 2 位小数，得到下面的数据

```
N1的卫星节点到 N1 的距离
0.57
7.74
9.18
1.01
0.76

N2 的卫星节点到 N2 的距离
3.63
0.68
6.12
8.61
3.84

N3 的卫星节点到 N3 的距离
9.17
2.22
9.85
8.51
1.12
```



#### 3.3 确定同一中心节点中卫星节点之间的距离

根据我们的方法：这个距离是取值范围[La1 - Lb1, La1 + Lb1] 之间的一个随机值。

使用下列代码来计算

```python
import random

l12 = 21.62
l13 = 24.42
l23 = 19.31

l1 = [0.57, 7.74, 9.18, 1.01, 0.76]
l2 = [3.63, 0.68, 6.12, 8.61, 3.84]
l3 = [9.17, 2.22, 9.85, 8.51, 1.12]


for i in range(5):
    for j in range(i+1, 5):
        print("%.2f" % (random.uniform(abs(l1[i] - l1[j]), l1[i] + l1[j])))
print


for i in range(5):
    for j in range(i+1, 5):
        print("%.2f" % (random.uniform(abs(l2[i] - l2[j]), l2[i] + l2[j])))
print

for i in range(5):
    for j in range(i+1, 5):
        print("%.2f" % (random.uniform(abs(l3[i] - l3[j]), l3[i] + l3[j])))
print
```



得到结果如下：

```
7.20
8.98
1.47
0.49
16.00
7.99
7.57
9.38
9.21
0.52

3.47
6.08
7.50
7.39
5.55
8.70
3.93
3.35
5.76
9.07

8.48
15.94
13.06
8.33
7.77
9.45
1.52
5.75
10.64
8.49
```





#### 3.4 确定卫星节点到其他中心节点的距离

根据我们的方法：这个距离是两个中心节点之间的距离加或减一个系数乘以卫星节点到中心节点之间的距离。

使用下列代码来计算

```python
import random

l12 = 21.62
l13 = 24.42
l23 = 19.31

l1 = [0.57, 7.74, 9.18, 1.01, 0.76]
l2 = [3.63, 0.68, 6.12, 8.61, 3.84]
l3 = [9.17, 2.22, 9.85, 8.51, 1.12]

# N1's stars to N2
for i in l1:
    print("%.2f" % (l12 + i* random.uniform(-1, 1)))
print

# N1's stars to N3
for i in l1:
    print("%.2f" % (l13 + i * random.uniform(-1, 1)))
print




# N2's stars to N1
for i in l2:
    print("%.2f" % (l12 + i* random.uniform(-1, 1)))
print

# N2's stars to N3
for i in l2:
    print("%.2f" % (l23 + i * random.uniform(-1, 1)))
print



# N3's stars to N1
for i in l3:
    print("%.2f" % (l13 + i* random.uniform(-1, 1)))

print

# N3's stars to N2
for i in l3:
    print("%.2f" % (l23 + i * random.uniform(-1, 1)))

```



得到下列数据

```
N1 的卫星节点到 N2
21.47
28.97
21.35
21.12
20.89

N1 的卫星节点到 N3
24.40
27.85
30.31
23.88
25.03

N2 的卫星节点到 N1
18.44
21.14
26.56
19.78
23.61

N2 的卫星节点到 N3
17.90
19.61
23.90
17.96
19.91

N3 的卫星节点到 N1
16.76
23.34
21.50
24.11
23.54

N3 的卫星节点到 N2
13.02
17.38
23.68
13.50
18.40
```



#### 3.4 确定卫星节点到卫星节点之间的距离

根据我们的方法：两个卫星节点之间的距离，等于两个中心节点之间的距离，加或减一个系数乘以两个卫星节点到各自中心节点距离的和。

使用下列代码计算：

```python
import random

l12 = 21.62
l13 = 24.42
l23 = 19.31

l1 = [0.57, 7.74, 9.18, 1.01, 0.76]
l2 = [3.63, 0.68, 6.12, 8.61, 3.84]
l3 = [9.17, 2.22, 9.85, 8.51, 1.12]


# N1's stars to N2's stars
for i in l1:
    for j in l2:
        print("%0.2f" % (l12 + (i+j) * random.uniform(-1, 1)))
    print
print
print


# N1's stars to N3's stars
for i in l1:
    for j in l3:
        print("%0.2f" % (l13 + (i+j) * random.uniform(-1, 1)))
    print
print
print


# N2's stars to N3's stars
for i in l2:
    for j in l3:
        print("%0.2f" % (l23 + (i+j) * random.uniform(-1, 1)))
    print
print
print

```

上面只需要 3 个循环就可以了，因为卫星节点到卫星节点之间的距离，两者是相等的。

得到下列结果：

```
N1 的第 1 个卫星节点到 N2 的所有卫星节点
18.79
22.33
28.24
20.79
23.40

N1 的第 2 个卫星节点到 N2 的所有卫星节点
10.47
19.58
11.97
17.15
12.21

N1 的第 3 个卫星节点到 N2 的所有卫星节点
16.17
25.17
6.62
37.80
15.45

N1 的第 4 个卫星节点到 N2 的所有卫星节点
25.82
20.50
15.36
21.77
21.49

N1 的第 5 个卫星节点到 N2 的所有卫星节点
19.21
22.96
18.89
22.72
20.42


N1 的第 1 个卫星节点到 N3 的所有卫星节点
18.78
25.77
25.47
15.34
26.08

N1 的第 2 个卫星节点到 N3 的所有卫星节点
11.71
32.15
16.72
40.13
26.01

N1 的第 3 个卫星节点到 N3 的所有卫星节点
11.66
26.84
12.99
34.76
30.03

N1 的第 4 个卫星节点到 N3 的所有卫星节点
29.29
23.51
19.49
19.35
24.02

N1 的第 5 个卫星节点到 N3 的所有卫星节点
31.77
22.22
26.90
28.28
26.02


N2 的第 1 个卫星节点到 N3 的所有卫星节点
18.24
22.64
19.38
27.24
14.79

N2 的第 2 个卫星节点到 N3 的所有卫星节点
10.25
16.57
28.24
10.80
20.63

N2 的第 3 个卫星节点到 N3 的所有卫星节点
4.48
16.02
14.44
26.07
25.23

N2 的第 4 个卫星节点到 N3 的所有卫星节点
9.90
24.59
37.70
6.67
13.57

N2 的第 5 个卫星节点到 N3 的所有卫星节点
32.04
24.70
16.57
19.08
19.81
```



### 4. 实验结果

将上面的实验结果进行整理，得到下面的矩阵：

N1、N2、N3 是三个中心节点。N12 表示 N1 的第二个卫星节点，其他类似。

|      | N1    | N2    | N3    | N11   | N12   | N13   | N14   | N15   | N21   | N22   | N23   | N24   | N25   | N31   | N32  | N33   | N34  | N35  |
| ---- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ---- | ----- | ---- | ---- |
| N1   | 0     |       |       |       |       |       |       |       |       |       |       |       |       |       |      |       |      |      |
| N2   | 21.62 | 0     |       |       |       |       |       |       |       |       |       |       |       |       |      |       |      |      |
| N3   | 24.42 | 19.31 | 0     |       |       |       |       |       |       |       |       |       |       |       |      |       |      |      |
| N11  | 0.57  | 21.47 | 24.4  | 0     |       |       |       |       |       |       |       |       |       |       |      |       |      |      |
| N12  | 7.74  | 28.97 | 27.85 | 7.2   | 0     |       |       |       |       |       |       |       |       |       |      |       |      |      |
| N13  | 9.18  | 21.35 | 30.31 | 8.98  | 16    | 0     |       |       |       |       |       |       |       |       |      |       |      |      |
| N14  | 1.01  | 21.12 | 23.88 | 1.47  | 7.99  | 9.38  | 0     |       |       |       |       |       |       |       |      |       |      |      |
| N15  | 0.76  | 20.89 | 25.03 | 0.49  | 7.57  | 9.21  | 0.52  | 0     |       |       |       |       |       |       |      |       |      |      |
| N21  | 18.44 | 3.63  | 17.9  | 18.79 | 10.47 | 16.17 | 25.82 | 19.21 | 0     |       |       |       |       |       |      |       |      |      |
| N22  | 21.14 | 0.68  | 19.61 | 22.33 | 19.58 | 25.17 | 20.5  | 22.96 | 3.47  | 0     |       |       |       |       |      |       |      |      |
| N23  | 26.56 | 6.12  | 23.9  | 28.24 | 11.97 | 6.62  | 15.36 | 18.89 | 6.08  | 5.55  | 0     |       |       |       |      |       |      |      |
| N24  | 19.78 | 8.61  | 17.96 | 20.79 | 17.15 | 37.8  | 21.77 | 22.72 | 7.5   | 8.7   | 3.35  | 0     |       |       |      |       |      |      |
| N25  | 23.61 | 3.84  | 19.91 | 23.4  | 12.21 | 15.45 | 21.49 | 20.42 | 7.39  | 3.93  | 5.76  | 9.07  | 0     |       |      |       |      |      |
| N31  | 16.76 | 13.02 | 9.17  | 18.78 | 11.71 | 11.66 | 29.29 | 31.77 | 18.24 | 10.25 | 4.48  | 9.9   | 32.04 | 0     |      |       |      |      |
| N32  | 23.34 | 17.38 | 2.22  | 25.77 | 32.15 | 26.84 | 23.51 | 22.22 | 22.64 | 16.57 | 16.02 | 24.59 | 24.7  | 8.48  | 0    |       |      |      |
| N33  | 21.5  | 23.68 | 9.85  | 25.47 | 16.72 | 12.99 | 19.49 | 26.9  | 19.38 | 28.24 | 14.44 | 37.7  | 16.57 | 15.94 | 7.77 | 0     |      |      |
| N34  | 24.11 | 13.5  | 8.51  | 15.34 | 40.13 | 34.76 | 19.35 | 28.28 | 27.24 | 10.8  | 26.07 | 6.67  | 19.08 | 13.06 | 9.45 | 5.75  | 0    |      |
| N35  | 23.54 | 18.4  | 1.12  | 26.08 | 26.01 | 30.03 | 24.02 | 26.02 | 14.79 | 20.63 | 25.23 | 13.57 | 19.81 | 8.33  | 1.52 | 10.64 | 8.49 | 0    |



翻转之后得到完整的矩阵：

|      | N1    | N2    | N3    | N11   | N12   | N13   | N14   | N15   | N21   | N22   | N23   | N24   | N25   | N31   | N32   | N33   | N34   | N35   |
| ---- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- |
| N1   | 0     | 21.62 | 24.42 | 0.57  | 7.74  | 9.18  | 1.01  | 0.76  | 18.44 | 21.14 | 26.56 | 19.78 | 23.61 | 16.76 | 23.34 | 21.5  | 24.11 | 23.54 |
| N2   | 21.62 | 0     | 19.31 | 21.47 | 28.97 | 21.35 | 21.12 | 20.89 | 3.63  | 0.68  | 6.12  | 8.61  | 3.84  | 13.02 | 17.38 | 23.68 | 13.5  | 18.4  |
| N3   | 24.42 | 19.31 | 0     | 24.4  | 27.85 | 30.31 | 23.88 | 25.03 | 17.9  | 19.61 | 23.9  | 17.96 | 19.91 | 9.17  | 2.22  | 9.85  | 8.51  | 1.12  |
| N11  | 0.57  | 21.47 | 24.4  | 0     | 7.2   | 8.98  | 1.47  | 0.49  | 18.79 | 22.33 | 28.24 | 20.79 | 23.4  | 18.78 | 25.77 | 25.47 | 15.34 | 26.08 |
| N12  | 7.74  | 28.97 | 27.85 | 7.2   | 0     | 16    | 7.99  | 7.57  | 10.47 | 19.58 | 11.97 | 17.15 | 12.21 | 11.71 | 32.15 | 16.72 | 40.13 | 26.01 |
| N13  | 9.18  | 21.35 | 30.31 | 8.98  | 16    | 0     | 9.38  | 9.21  | 16.17 | 25.17 | 6.62  | 37.8  | 15.45 | 11.66 | 26.84 | 12.99 | 34.76 | 30.03 |
| N14  | 1.01  | 21.12 | 23.88 | 1.47  | 7.99  | 9.38  | 0     | 0.52  | 25.82 | 20.5  | 15.36 | 21.77 | 21.49 | 29.29 | 23.51 | 19.49 | 19.35 | 24.02 |
| N15  | 0.76  | 20.89 | 25.03 | 0.49  | 7.57  | 9.21  | 0.52  | 0     | 19.21 | 22.96 | 18.89 | 22.72 | 20.42 | 31.77 | 22.22 | 26.9  | 28.28 | 26.02 |
| N21  | 18.44 | 3.63  | 17.9  | 18.79 | 10.47 | 16.17 | 25.82 | 19.21 | 0     | 3.47  | 6.08  | 7.5   | 7.39  | 18.24 | 22.64 | 19.38 | 27.24 | 14.79 |
| N22  | 21.14 | 0.68  | 19.61 | 22.33 | 19.58 | 25.17 | 20.5  | 22.96 | 3.47  | 0     | 5.55  | 8.7   | 3.93  | 10.25 | 16.57 | 28.24 | 10.8  | 20.63 |
| N23  | 26.56 | 6.12  | 23.9  | 28.24 | 11.97 | 6.62  | 15.36 | 18.89 | 6.08  | 5.55  | 0     | 3.35  | 5.76  | 4.48  | 16.02 | 14.44 | 26.07 | 25.23 |
| N24  | 19.78 | 8.61  | 17.96 | 20.79 | 17.15 | 37.8  | 21.77 | 22.72 | 7.5   | 8.7   | 3.35  | 0     | 9.07  | 9.9   | 24.59 | 37.7  | 6.67  | 13.57 |
| N25  | 23.61 | 3.84  | 19.91 | 23.4  | 12.21 | 15.45 | 21.49 | 20.42 | 7.39  | 3.93  | 5.76  | 9.07  | 0     | 32.04 | 24.7  | 16.57 | 19.08 | 19.81 |
| N31  | 16.76 | 13.02 | 9.17  | 18.78 | 11.71 | 11.66 | 29.29 | 31.77 | 18.24 | 10.25 | 4.48  | 9.9   | 32.04 | 0     | 8.48  | 15.94 | 13.06 | 8.33  |
| N32  | 23.34 | 17.38 | 2.22  | 25.77 | 32.15 | 26.84 | 23.51 | 22.22 | 22.64 | 16.57 | 16.02 | 24.59 | 24.7  | 8.48  | 0     | 7.77  | 9.45  | 1.52  |
| N33  | 21.5  | 23.68 | 9.85  | 25.47 | 16.72 | 12.99 | 19.49 | 26.9  | 19.38 | 28.24 | 14.44 | 37.7  | 16.57 | 15.94 | 7.77  | 0     | 5.75  | 10.64 |
| N34  | 24.11 | 13.5  | 8.51  | 15.34 | 40.13 | 34.76 | 19.35 | 28.28 | 27.24 | 10.8  | 26.07 | 6.67  | 19.08 | 13.06 | 9.45  | 5.75  | 0     | 8.49  |
| N35  | 23.54 | 18.4  | 1.12  | 26.08 | 26.01 | 30.03 | 24.02 | 26.02 | 14.79 | 20.63 | 25.23 | 13.57 | 19.81 | 8.33  | 1.52  | 10.64 | 8.49  | 0     |



## 二、信用度距离

### 1. 得到信用度

我们讨论的方案中，需要用到每个节点的信用度。由于目前我们还没有信用度的具体数据，这里我们采用随机分配的方式，来获得 20 个节点的信用值。

方法是通过在这 20 台机器上查看 RANDOM 随机变量来获取随机值。取值范围是 0 ~ 32767。为了跟上面的网络延迟时间相匹配，这里选择取余100 的操作。

```bash
echo $((`echo $RANDOM` % 100))
```

得到下面的列表：

1. 51
2. 53
3. 56
4. 89
5. 79
6. 5
7. 83
8. 2
9. 84
10. 12
11. 72
12. 35
13. 51
14. 14
15. 24
16. 32
17. 72
18. 15
19. 69
20. 14



### 2. 距离的计算

上面得到了每个节点的信用度，但是 K-means 算法中需要使用 distence，是两者之间的一种关系。

这里选择将两个节点信用度的差的绝对值作为一个 distence。

得到下面的矩阵：

|        | Node1 | Node2 | Node3 | Node4 | Node5 | Node6 | Node7 | Node8 | Node9 | Node10 | Node11 | Node12 | Node13 | Node14 | Node15 | Node16 | Node17 | Node18 | Node19 | Node20 |
| ------ | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| Node1  | 0     | 2     | 5     | 38    | 28    | 46    | 32    | 49    | 33    | 39     | 21     | 16     | 0      | 37     | 27     | 19     | 21     | 36     | 18     | 37     |
| Node2  | 2     | 0     | 3     | 36    | 26    | 48    | 30    | 51    | 31    | 41     | 19     | 18     | 2      | 39     | 29     | 21     | 19     | 38     | 16     | 39     |
| Node3  | 5     | 3     | 0     | 33    | 23    | 51    | 27    | 54    | 28    | 44     | 16     | 21     | 5      | 42     | 32     | 24     | 16     | 41     | 13     | 42     |
| Node4  | 38    | 36    | 33    | 0     | 10    | 84    | 6     | 87    | 5     | 77     | 17     | 54     | 38     | 75     | 65     | 57     | 17     | 74     | 20     | 75     |
| Node5  | 28    | 26    | 23    | 10    | 0     | 74    | 4     | 77    | 5     | 67     | 7      | 44     | 28     | 65     | 55     | 47     | 7      | 64     | 10     | 65     |
| Node6  | 46    | 48    | 51    | 84    | 74    | 0     | 78    | 3     | 79    | 7      | 67     | 30     | 46     | 9      | 19     | 27     | 67     | 10     | 64     | 9      |
| Node7  | 32    | 30    | 27    | 6     | 4     | 78    | 0     | 81    | 1     | 71     | 11     | 48     | 32     | 69     | 59     | 51     | 11     | 68     | 14     | 69     |
| Node8  | 49    | 51    | 54    | 87    | 77    | 3     | 81    | 0     | 82    | 10     | 70     | 33     | 49     | 12     | 22     | 30     | 70     | 13     | 67     | 12     |
| Node9  | 33    | 31    | 28    | 5     | 5     | 79    | 1     | 82    | 0     | 72     | 12     | 49     | 33     | 70     | 60     | 52     | 12     | 69     | 15     | 70     |
| Node10 | 39    | 41    | 44    | 77    | 67    | 7     | 71    | 10    | 72    | 0      | 60     | 23     | 39     | 2      | 12     | 20     | 60     | 3      | 57     | 2      |
| Node11 | 21    | 19    | 16    | 17    | 7     | 67    | 11    | 70    | 12    | 60     | 0      | 37     | 21     | 58     | 48     | 40     | 0      | 57     | 3      | 58     |
| Node12 | 16    | 18    | 21    | 54    | 44    | 30    | 48    | 33    | 49    | 23     | 37     | 0      | 16     | 21     | 11     | 3      | 37     | 20     | 34     | 21     |
| Node13 | 0     | 2     | 5     | 38    | 28    | 46    | 32    | 49    | 33    | 39     | 21     | 16     | 0      | 37     | 27     | 19     | 21     | 36     | 18     | 37     |
| Node14 | 37    | 39    | 42    | 75    | 65    | 9     | 69    | 12    | 70    | 2      | 58     | 21     | 37     | 0      | 10     | 18     | 58     | 1      | 55     | 0      |
| Node15 | 27    | 29    | 32    | 65    | 55    | 19    | 59    | 22    | 60    | 12     | 48     | 11     | 27     | 10     | 0      | 8      | 48     | 9      | 45     | 10     |
| Node16 | 19    | 21    | 24    | 57    | 47    | 27    | 51    | 30    | 52    | 20     | 40     | 3      | 19     | 18     | 8      | 0      | 40     | 17     | 37     | 18     |
| Node17 | 21    | 19    | 16    | 17    | 7     | 67    | 11    | 70    | 12    | 60     | 0      | 37     | 21     | 58     | 48     | 40     | 0      | 57     | 3      | 58     |
| Node18 | 36    | 38    | 41    | 74    | 64    | 10    | 68    | 13    | 69    | 3      | 57     | 20     | 36     | 1      | 9      | 17     | 57     | 0      | 54     | 1      |
| Node19 | 18    | 16    | 13    | 20    | 10    | 64    | 14    | 67    | 15    | 57     | 3      | 34     | 18     | 55     | 45     | 37     | 3      | 54     | 0      | 55     |
| Node20 | 37    | 39    | 42    | 75    | 65    | 9     | 69    | 12    | 70    | 2      | 58     | 21     | 37     | 0      | 10     | 18     | 58     | 1      | 55     | 0      |



## 三、规一
### 3. 计算矩阵

我们暂定的公式是：将网络延迟的矩阵与信用度的矩阵进行线性计算，可以得到我们的 distence 矩阵。

假设 2 个节点之间的网络延迟数据是 x，信用度差值是 y，那么

```
distence = ax + by
```

当 a = 1，b = 1 时，得出的 distence 矩阵如下：

|      | N1     | N2     | N3     | N4     | N5     | N6     | N7     | N8     | N9    | N10    | N11   | N12   | N13   | N14   | N15    | N16    | N17    | N18    | N19    | N20    |
| ---- | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ----- | ------ | ----- | ----- | ----- | ----- | ------ | ------ | ------ | ------ | ------ | ------ |
| N1   | 0      | 2.393  | 5.371  | 38.583 | 28.417 | 48.01  | 33.64  | 50.59  | 110.9 | 39.329 | 248   | 234   | 46.2  | 93.6  | 28.64  | 19.373 | 59.4   | 91.2   | 18.424 | 37.409 |
| N2   | 2.393  | 0      | 3.385  | 36.512 | 26.414 | 49.76  | 31.39  | 52.35  | 108.3 | 41.345 | 237   | 188   | 48.3  | 96.2  | 30.35  | 21.367 | 57.5   | 76.7   | 16.407 | 39.319 |
| N3   | 5.371  | 3.385  | 0      | 33.458 | 23.402 | 52.89  | 28.71  | 55.67  | 104.6 | 44.355 | 242   | 200   | 50.4  | 85.5  | 33.92  | 24.369 | 57.3   | 93.1   | 13.412 | 42.379 |
| N4   | 38.583 | 36.512 | 33.458 | 0      | 10.426 | 86.75  | 7.74   | 88.95  | 83.4  | 77.354 | 243   | 218   | 83.8  | 132.1 | 66.86  | 57.414 | 61.2   | 118.6  | 20.449 | 75.416 |
| N5   | 28.417 | 26.414 | 23.402 | 10.426 | 0      | 75.71  | 5.39   | 78.71  | 83.7  | 67.383 | 246   | 285   | 72    | 145.8 | 56.37  | 47.449 | 60.1   | 113.2  | 10.428 | 65.384 |
| N6   | 48.01  | 49.76  | 52.89  | 86.75  | 75.71  | 0      | 78.44  | 3.38   | 157.4 | 8.68   | 319   | 215   | 91.7  | 66.8  | 19.436 | 28.66  | 109.5  | 51.8   | 65.44  | 10.9   |
| N7   | 33.64  | 31.39  | 28.71  | 7.74   | 5.39   | 78.44  | 0      | 81.461 | 81.9  | 72.9   | 241   | 223   | 76.9  | 159.4 | 59.331 | 52.33  | 52.8   | 120.6  | 15.61  | 70.72  |
| N8   | 50.59  | 52.35  | 55.67  | 88.95  | 78.71  | 3.38   | 81.461 | 0      | 162.6 | 11.55  | 297   | 206   | 95.1  | 69.8  | 22.388 | 31.35  | 108.8  | 55     | 68.37  | 14.05  |
| N9   | 110.9  | 108.3  | 104.6  | 83.4   | 83.7   | 157.4  | 81.9   | 162.6  | 0     | 152.3  | 269   | 275   | 66.5  | 136.6 | 147.4  | 130.6  | 53.1   | 107.1  | 94.8   | 149.1  |
| N10  | 39.329 | 41.345 | 44.355 | 77.354 | 67.383 | 8.68   | 72.9   | 11.55  | 152.3 | 0      | 288   | 196   | 83.4  | 52.7  | 13.55  | 20.367 | 98.2   | 43.7   | 57.387 | 2.404  |
| N11  | 248    | 237    | 242    | 243    | 246    | 319    | 241    | 297    | 269   | 288    | 0     | 127.7 | 241   | 307   | 319    | 264    | 231    | 284    | 222    | 289    |
| N12  | 234    | 188    | 200    | 218    | 285    | 215    | 223    | 206    | 275   | 196    | 127.7 | 0     | 215   | 236   | 247    | 182    | 359    | 341    | 249    | 190    |
| N13  | 46.2   | 48.3   | 50.4   | 83.8   | 72     | 91.7   | 76.9   | 95.1   | 66.5  | 83.4   | 241   | 215   | 0     | 73.7  | 73.4   | 63.5   | 22.99  | 37.77  | 61.8   | 81     |
| N14  | 93.6   | 96.2   | 85.5   | 132.1  | 145.8  | 66.8   | 159.4  | 69.8   | 136.6 | 52.7   | 307   | 236   | 73.7  | 0     | 56.7   | 64.9   | 95.5   | 44.4   | 111.8  | 93.4   |
| N15  | 28.64  | 30.35  | 33.92  | 66.86  | 56.37  | 19.436 | 59.331 | 22.388 | 147.4 | 13.55  | 319   | 247   | 73.4  | 56.7  | 0      | 9.38   | 100.7  | 61.8   | 46.4   | 11.96  |
| N16  | 19.373 | 21.367 | 24.369 | 57.414 | 47.449 | 28.66  | 52.33  | 31.35  | 130.6 | 20.367 | 264   | 182   | 63.5  | 64.9  | 9.38   | 0      | 79.3   | 55.1   | 37.406 | 18.382 |
| N17  | 59.4   | 57.5   | 57.3   | 61.2   | 60.1   | 109.5  | 52.8   | 108.8  | 53.1  | 98.2   | 231   | 359   | 22.99 | 95.5  | 100.7  | 79.3   | 0      | 57.482 | 55.8   | 99.3   |
| N18  | 91.2   | 76.7   | 93.1   | 118.6  | 113.2  | 51.8   | 120.6  | 55     | 107.1 | 43.7   | 284   | 341   | 37.77 | 44.4  | 61.8   | 55.1   | 57.482 | 0      | 98.4   | 38.9   |
| N19  | 18.424 | 16.407 | 13.412 | 20.449 | 10.428 | 65.44  | 15.61  | 68.37  | 94.8  | 57.387 | 222   | 249   | 61.8  | 111.8 | 46.4   | 37.406 | 55.8   | 98.4   | 0      | 55.415 |
| N20  | 37.409 | 39.319 | 42.379 | 75.416 | 65.384 | 10.9   | 70.72  | 14.05  | 149.1 | 2.404  | 289   | 190   | 81    | 93.4  | 11.96  | 18.382 | 99.3   | 38.9   | 55.415 | 0      |





## 四、权重



## 可视化

这里试图通过上面得到的距离矩阵，将各个点在二维平面上描绘出来。

采用的是“多维尺度法”（Multidimensional Scaling， MDS)，进行画图。

下面是 Matlab 实现代码

```matlab
clc;
clear all;
close all;

%distance matrix for 20 nodes.
d=[0, 2.393, 5.371, 38.583, 28.417, 48.01, 33.64, 50.59, 110.9, 39.329, 248, 234, 46.2, 93.6, 28.64, 19.373, 59.4, 91.2, 18.424, 37.409;
2.393, 0, 3.385, 36.512, 26.414, 49.76, 31.39, 52.35, 108.3, 41.345, 237, 188, 48.3, 96.2, 30.35, 21.367, 57.5, 76.7, 16.407, 39.319;
5.371, 3.385, 0, 33.458, 23.402, 52.89, 28.71, 55.67, 104.6, 44.355, 242, 200, 50.4, 85.5, 33.92, 24.369, 57.3, 93.1, 13.412, 42.379;
38.583, 36.512, 33.458, 0, 10.426, 86.75, 7.74, 88.95, 83.4, 77.354, 243, 218, 83.8, 132.1, 66.86, 57.414, 61.2, 118.6, 20.449, 75.416;
28.417, 26.414, 23.402, 10.426, 0, 75.71, 5.39, 78.71, 83.7, 67.383, 246, 285, 72, 145.8, 56.37, 47.449, 60.1, 113.2, 10.428, 65.384;
48.01, 49.76, 52.89, 86.75, 75.71, 0, 78.44, 3.38, 157.4, 8.68, 319, 215, 91.7, 66.8, 19.436, 28.66, 109.5, 51.8, 65.44, 10.9;
33.64, 31.39, 28.71, 7.74, 5.39, 78.44, 0, 81.461, 81.9, 72.9, 241, 223, 76.9, 159.4, 59.331, 52.33, 52.8, 120.6, 15.61, 70.72;
50.59, 52.35, 55.67, 88.95, 78.71, 3.38, 81.461, 0, 162.6, 11.55, 297, 206, 95.1, 69.8, 22.388, 31.35, 108.8, 55, 68.37, 14.05;
110.9, 108.3, 104.6, 83.4, 83.7, 157.4, 81.9, 162.6, 0, 152.3, 269, 275, 66.5, 136.6, 147.4, 130.6, 53.1, 107.1, 94.8, 149.1;
39.329, 41.345, 44.355, 77.354, 67.383, 8.68, 72.9, 11.55, 152.3, 0, 288, 196, 83.4, 52.7, 13.55, 20.367, 98.2, 43.7, 57.387, 2.404;
248, 237, 242, 243, 246, 319, 241, 297, 269, 288, 0, 127.7, 241, 307, 319, 264, 231, 284, 222, 289;
234, 188, 200, 218, 285, 215, 223, 206, 275, 196, 127.7, 0, 215, 236, 247, 182, 359, 341, 249, 190;
46.2, 48.3, 50.4, 83.8, 72, 91.7, 76.9, 95.1, 66.5, 83.4, 241, 215, 0, 73.7, 73.4, 63.5, 22.99, 37.77, 61.8, 81;
93.6, 96.2, 85.5, 132.1, 145.8, 66.8, 159.4, 69.8, 136.6, 52.7, 307, 236, 73.7, 0, 56.7, 64.9, 95.5, 44.4, 111.8, 93.4;
28.64, 30.35, 33.92, 66.86, 56.37, 19.436, 59.331, 22.388, 147.4, 13.55, 319, 247, 73.4, 56.7, 0, 9.38, 100.7, 61.8, 46.4, 11.96;
19.373, 21.367, 24.369, 57.414, 47.449, 28.66, 52.33, 31.35, 130.6, 20.367, 264, 182, 63.5, 64.9, 9.38, 0, 79.3, 55.1, 37.406, 18.382;
59.4, 57.5, 57.3, 61.2, 60.1, 109.5, 52.8, 108.8, 53.1, 98.2, 231, 359, 22.99, 95.5, 100.7, 79.3, 0, 57.482, 55.8, 99.3;
91.2, 76.7, 93.1, 118.6, 113.2, 51.8, 120.6, 55, 107.1, 43.7, 284, 341, 37.77, 44.4, 61.8, 55.1, 57.482, 0, 98.4, 38.9;
18.424, 16.407, 13.412, 20.449, 10.428, 65.44, 15.61, 68.37, 94.8, 57.387, 222, 249, 61.8, 111.8, 46.4, 37.406, 55.8, 98.4, 0, 55.415;
37.409, 39.319, 42.379, 75.416, 65.384, 10.9, 70.72, 14.05, 149.1, 2.404, 289, 190, 81, 93.4, 11.96, 18.382, 99.3, 38.9, 55.415, 0;];

n=size(d,1);
t=zeros(n,n);
for i=1:n
    for j=1:n
        t(i,j)=-0.5*(d(i,j)^2 -1/n*d(i,:)*d(i,:)' -1/n*d(:,j)'*d(:,j) +1/n^2*sum(sum(d.^2)));
    end
end
[V,D] = eig(t)
X=V(:,1:2)*D(1:2,1:2).^(1/2);
scatter(-X(:,2),X(:,1));
axis([-300,300,-300,300]);
```



得到下面的图

![image-20200731092421140](.\image1.png)



**这里需要说明的是：并不是所有的二维距离矩阵都能转化成二维图。**



20 个点的坐标是：

| X         | Y         |
| --------- | --------- |
| 4.7102    | 13.8498   |
| -4.919    | -8.1056   |
| -3.5211   | -2.406    |
| 15.5089   | -1.3709   |
| 41.3251   | 32.0813   |
| -63.6863  | 41.9801   |
| 19.8858   | -0.7107   |
| -54.6698  | 25.5969   |
| 65.7593   | 25.3744   |
| -48.6297  | 19.2336   |
| 122.8542  | -217.3484 |
| -106.9949 | -219.186  |
| 17.1332   | 3.3957    |
| -44.3308  | 41.2467   |
| -46.0851  | 56.7392   |
| -30.8095  | 3.3463    |
| 103.2811  | 72.0551   |
| 31.3568   | 89.8609   |
| 30.1838   | 7.5496    |
| -48.3522  | 16.8181   |





## 五、K-means 分组

利用上面的 20 个节点的坐标，以及之前写好的 [python 代码](https://github.com/triasteam/go-streamnet/blob/master/examples/k-means/k-means.py) 。

运行如下：

1. 先将点在图上画出，并指定三个初始质点（红，蓝，绿）

   ![1](.\image2.png)

2. 第一次分组

   ![2](.\image3.png)

3. 在组内寻址新的质点

   ![3](.\image4.png)

4. 再次分组，再次寻找，直到不再变化

   ![4](.\image5.png)

   

5. 

